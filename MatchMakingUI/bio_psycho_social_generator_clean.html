<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üé¨ Smart Video Clipper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { primary: '#10b981' },
          fontFamily: { mono: ['Fira Code', 'monospace'] }
        }
      }
    };
  </script>
</head>
<body class="dark bg-gray-900 text-gray-100">
  <div class="max-w-3xl mx-auto mt-12 bg-gray-800 shadow-xl rounded-lg p-8">
    <h1 class="text-2xl font-semibold mb-6">üé¨ AI Video Clipper</h1>

    <label class="block font-medium mb-1 text-gray-300">Vimeo Video ID:</label>
    <input type="text" id="videoID" placeholder="e.g. 987654321"
      class="w-full p-3 border border-gray-600 rounded bg-gray-900 text-white mb-4 placeholder-gray-500" />

    <label class="block font-medium mb-1 text-gray-300">How many clips?</label>
    <input type="number" id="clipCount" min="1" value="3"
      class="w-full p-3 border border-gray-600 rounded bg-gray-900 text-white mb-4" />

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-medium mb-1 text-gray-300">Min clip length (seconds):</label>
        <input type="number" id="minLength" min="5" value="30"
          class="w-full p-3 border border-gray-600 rounded bg-gray-900 text-white mb-4" />
      </div>
      <div>
        <label class="block font-medium mb-1 text-gray-300">Max clip length (seconds):</label>
        <input type="number" id="maxLength" min="5" value="120"
          class="w-full p-3 border border-gray-600 rounded bg-gray-900 text-white mb-4" />
      </div>
    </div>

    <label class="block font-medium mb-1 text-gray-300">Specific clip needs or focus areas:</label>
    <textarea id="userRequest"
      placeholder="Example: Focus on when the speaker discusses leadership and teamwork."
      class="w-full p-3 border border-gray-600 rounded bg-gray-900 text-white placeholder-gray-500 mb-4 resize-y h-28"></textarea>

    <button class="bg-primary text-white px-5 py-3 rounded hover:bg-emerald-600 transition w-full"
      onclick="generateClips()">Generate Clips</button>

    <p id="statusMessage" class="mt-4 text-sm text-gray-400 font-medium"></p>

    <div id="outputSection" class="hidden mt-6 bg-gray-700 p-6 rounded-md">
      <h2 class="text-lg font-semibold mb-3 text-white">üéûÔ∏è Generated Clips</h2>
      <div id="generatedOutput" class="space-y-4 text-gray-200"></div>
    </div>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-emerald-500 border-opacity-75"></div>
  </div>

  <script>
    async function generateClips() {
      const videoId = document.getElementById("videoID").value.trim();
      const clipCount = parseInt(document.getElementById("clipCount").value);
      const minLen = parseInt(document.getElementById("minLength").value);
      const maxLen = parseInt(document.getElementById("maxLength").value);
      const userRequest = document.getElementById("userRequest").value.trim();

      if (!videoId) return alert("Enter a Vimeo Video ID.");
      if (clipCount <= 0) return alert("Number of clips must be at least 1.");

      document.getElementById("statusMessage").innerText = "‚è≥ Processing video and generating timestamps...";
      document.getElementById("loadingOverlay").classList.remove("hidden");

      try {
        const response = await fetch("/api/run_pipeline", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ video_id: videoId })
        });

        const result = await response.json();

        if (!response.ok || !result.success)
          throw new Error(result.error || "Pipeline failed.");

        const transcript = result.transcript;
        const metadata = result.metadata;

        const prompt = `
You are an expert AI Video Clipper.

Analyze the provided transcript and metadata from a Vimeo video. Your job is to generate time stamps of clips for the purpose the user determines in ${userRequest }. These clips will most commonly be used for advertising, fundraising, and content engagement.
Return exactly ${clipCount} short clips with:
- A start and end timestamp (hh:mm:ss format)
- A short 1-2 sentence summary of what is covered in that clip

Each clip should be between ${minLen} and ${maxLen} seconds long.

If the user provides specific clip needs, prioritize those first.
Otherwise, choose clips that best capture the **main ideas** of the video.

Format each clip in plain text, like this:

Clip 1  
Start: 00:01:05  
End: 00:02:10
Clip Length: mm:ss  
Summary: Introduction to topic.

Clip 2  
Start: 00:03:15  
End: 00:04:45
Clip Length: mm:ss  
Summary: User-requested focus on teamwork.

### User Request:
${userRequest || "No specific request provided."}

### Video Metadata:
${metadata}

### Transcript:
${transcript}
        `.trim();

        const gptResponse = await fetch("/api/generate-profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const data = await gptResponse.json();
        const rawOutput = data.content || "‚ö†Ô∏è No response from GPT.";

        // Convert timestamps into clickable Vimeo links
        const processedOutput = rawOutput.replace(
          /(Start:\s*)(\d{2}:\d{2}:\d{2})/g,
          (match, label, time) => {
            const seconds = toSeconds(time);
            return `${label}<a href="https://vimeo.com/${videoId}#t=${seconds}" target="_blank" class="text-emerald-400 underline">${time}</a>`;
          }
        );

        document.getElementById("loadingOverlay").classList.add("hidden");
        document.getElementById("outputSection").classList.remove("hidden");
        document.getElementById("generatedOutput").innerHTML =
          `<pre class='whitespace-pre-wrap text-sm bg-gray-800 p-4 rounded border border-gray-600 text-green-300'>${processedOutput}</pre>`;
        document.getElementById("statusMessage").innerText = "‚úÖ Timestamps generated successfully!";
      } catch (err) {
        document.getElementById("loadingOverlay").classList.add("hidden");
        document.getElementById("statusMessage").innerText = "‚ùå Error: " + err.message;
        console.error(err);
      }
    }

    // Helper: convert hh:mm:ss ‚Üí seconds
    function toSeconds(timeStr) {
      const [h, m, s] = timeStr.split(":").map(Number);
      return h * 3600 + m * 60 + s;
    }
  </script>
</body>
</html>
